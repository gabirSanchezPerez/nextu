"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Observable_1 = require("../Observable");
var identity_1 = require("../util/identity");
var isScheduler_1 = require("../util/isScheduler");
function generate(initialStateOrOptions, condition, iterate, resultSelectorOrObservable, scheduler) {
    var resultSelector;
    var initialState;
    if (arguments.length == 1) {
        var options = initialStateOrOptions;
        initialState = options.initialState;
        condition = options.condition;
        iterate = options.iterate;
        resultSelector = options.resultSelector || identity_1.identity;
        scheduler = options.scheduler;
    }
    else if (resultSelectorOrObservable === undefined || isScheduler_1.isScheduler(resultSelectorOrObservable)) {
        initialState = initialStateOrOptions;
        resultSelector = identity_1.identity;
        scheduler = resultSelectorOrObservable;
    }
    else {
        initialState = initialStateOrOptions;
        resultSelector = resultSelectorOrObservable;
    }
    return new Observable_1.Observable(function (subscriber) {
        var state = initialState;
        if (scheduler) {
            return scheduler.schedule(dispatch, 0, {
                subscriber: subscriber,
                iterate: iterate,
                condition: condition,
                resultSelector: resultSelector,
                state: state
            });
        }
        do {
            if (condition) {
                var conditionResult = void 0;
                try {
                    conditionResult = condition(state);
                }
                catch (err) {
                    subscriber.error(err);
                    return undefined;
                }
                if (!conditionResult) {
                    subscriber.complete();
                    break;
                }
            }
            var value = void 0;
            try {
                value = resultSelector(state);
            }
            catch (err) {
                subscriber.error(err);
                return undefined;
            }
            subscriber.next(value);
            if (subscriber.closed) {
                break;
            }
            try {
                state = iterate(state);
            }
            catch (err) {
                subscriber.error(err);
                return undefined;
            }
        } while (true);
        return undefined;
    });
}
exports.generate = generate;
function dispatch(state) {
    var subscriber = state.subscriber, condition = state.condition;
    if (subscriber.closed) {
        return undefined;
    }
    if (state.needIterate) {
        try {
            state.state = state.iterate(state.state);
        }
        catch (err) {
            subscriber.error(err);
            return undefined;
        }
    }
    else {
        state.needIterate = true;
    }
    if (condition) {
        var conditionResult = void 0;
        try {
            conditionResult = condition(state.state);
        }
        catch (err) {
            subscriber.error(err);
            return undefined;
        }
        if (!conditionResult) {
            subscriber.complete();
            return undefined;
        }
        if (subscriber.closed) {
            return undefined;
        }
    }
    var value;
    try {
        value = state.resultSelector(state.state);
    }
    catch (err) {
        subscriber.error(err);
        return undefined;
    }
    if (subscriber.closed) {
        return undefined;
    }
    subscriber.next(value);
    if (subscriber.closed) {
        return undefined;
    }
    return this.schedule(state);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJnZW5lcmF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDRDQUEyQztBQUUzQyw2Q0FBNEM7QUFFNUMsbURBQWtEO0FBOFBsRCxTQUFnQixRQUFRLENBQU8scUJBQWdELEVBQ2hELFNBQTRCLEVBQzVCLE9BQXdCLEVBQ3hCLDBCQUErRCxFQUMvRCxTQUF5QjtJQUV0RCxJQUFJLGNBQWdDLENBQUM7SUFDckMsSUFBSSxZQUFlLENBQUM7SUFFcEIsSUFBSSxTQUFTLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRTtRQUN6QixJQUFNLE9BQU8sR0FBRyxxQkFBOEMsQ0FBQztRQUMvRCxZQUFZLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUNwQyxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUM5QixPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQztRQUMxQixjQUFjLEdBQUcsT0FBTyxDQUFDLGNBQWMsSUFBSSxtQkFBNEIsQ0FBQztRQUN4RSxTQUFTLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztLQUMvQjtTQUFNLElBQUksMEJBQTBCLEtBQUssU0FBUyxJQUFJLHlCQUFXLENBQUMsMEJBQTBCLENBQUMsRUFBRTtRQUM5RixZQUFZLEdBQUcscUJBQTBCLENBQUM7UUFDMUMsY0FBYyxHQUFHLG1CQUE0QixDQUFDO1FBQzlDLFNBQVMsR0FBRywwQkFBMkMsQ0FBQztLQUN6RDtTQUFNO1FBQ0wsWUFBWSxHQUFHLHFCQUEwQixDQUFDO1FBQzFDLGNBQWMsR0FBRywwQkFBOEMsQ0FBQztLQUNqRTtJQUVELE9BQU8sSUFBSSx1QkFBVSxDQUFJLFVBQUEsVUFBVTtRQUNqQyxJQUFJLEtBQUssR0FBRyxZQUFZLENBQUM7UUFDekIsSUFBSSxTQUFTLEVBQUU7WUFDYixPQUFPLFNBQVMsQ0FBQyxRQUFRLENBQXVCLFFBQVEsRUFBRSxDQUFDLEVBQUU7Z0JBQzNELFVBQVUs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ckIsT0FBTyxTQUFTLENBQUM7S0FDbEI7SUFDRCxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLElBQUksVUFBVSxDQUFDLE1BQU0sRUFBRTtRQUNyQixPQUFPLFNBQVMsQ0FBQztLQUNsQjtJQUNELE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUM5QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJy4uL09ic2VydmFibGUnO1xuaW1wb3J0IHsgU3Vic2NyaWJlciB9IGZyb20gJy4uL1N1YnNjcmliZXInO1xuaW1wb3J0IHsgaWRlbnRpdHkgfSBmcm9tICcuLi91dGlsL2lkZW50aXR5JztcbmltcG9ydCB7IFNjaGVkdWxlckFjdGlvbiwgU2NoZWR1bGVyTGlrZSB9IGZyb20gJy4uL3R5cGVzJztcbmltcG9ydCB7IGlzU2NoZWR1bGVyIH0gZnJvbSAnLi4vdXRpbC9pc1NjaGVkdWxlcic7XG5cbmV4cG9ydCB0eXBlIENvbmRpdGlvbkZ1bmM8Uz4gPSAoc3RhdGU6IFMpID0+IGJvb2xlYW47XG5leHBvcnQgdHlwZSBJdGVyYXRlRnVuYzxTPiA9IChzdGF0ZTogUykgPT4gUztcbmV4cG9ydCB0eXBlIFJlc3VsdEZ1bmM8UywgVD4gPSAoc3RhdGU6IFMpID0+IFQ7XG5cbmludGVyZmFjZSBTY2hlZHVsZXJTdGF0ZTxULCBTPiB7XG4gIG5lZWRJdGVyYXRlPzogYm9vbGVhbjtcbiAgc3RhdGU6IFM7XG4gIHN1YnNjcmliZXI6IFN1YnNjcmliZXI8VD47XG4gIGNvbmRpdGlvbj86IENvbmRpdGlvbkZ1bmM8Uz47XG4gIGl0ZXJhdGU6IEl0ZXJhdGVGdW5jPFM+O1xuICByZXN1bHRTZWxlY3RvcjogUmVzdWx0RnVuYzxTLCBUPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBHZW5lcmF0ZUJhc2VPcHRpb25zPFM+IHtcbiAgLyoqXG4gICAqIEluaXRpYWwgc3RhdGUuXG4gICAqL1xuICBpbml0aWFsU3RhdGU6IFM7XG4gIC8qKlxuICAgKiBDb25kaXRpb24gZnVuY3Rpb24gdGhhdCBhY2NlcHRzIHN0YXRlIGFuZCByZXR1cm5zIGJvb2xlYW4uXG4gICAqIFdoZW4gaXQgcmV0dXJucyBmYWxzZSwgdGhlIGdlbmVyYXRvciBzdG9wcy5cbiAgICogSWYgbm90IHNwZWNpZmllZCwgYSBnZW5lcmF0b3IgbmV2ZXIgc3RvcHMuXG4gICAqL1xuICBjb25kaXRpb24/OiBDb25kaXRpb25GdW5jPFM+O1xuICAvKipcbiAgICogSXRlcmF0ZSBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgc3RhdGUgYW5kIHJldHVybnMgbmV3IHN0YXRlLlxuICAgKi9cbiAgaXRlcmF0ZTogSXRlcmF0ZUZ1bmM8Uz47XG4gIC8qKlxuICAgKiBTY2hlZHVsZXJMaWtlIHRvIHVzZSBmb3IgZ2VuZXJhdGlvbiBwcm9jZXNzLlxuICAgKiBCeSBkZWZhdWx0LCBhIGdlbmVyYXRvciBzdGFydHMgaW1tZWRpYXRlbHkuXG4gICAqL1xuICBzY2hlZHVsZXI/OiBTY2hlZHVsZXJMaWtlO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdlbmVyYXRlT3B0aW9uczxULCBTPiBleHRlbmRzIEdlbmVyYXRlQmFzZU9wdGlvbnM8Uz4ge1xuICAvKipcbiAgICogUmVzdWx0IHNlbGVjdGlvbiBmdW5jdGlvbiB0aGF0IGFjY2VwdHMgc3RhdGUgYW5kIHJldHVybnMgYSB2YWx1ZSB0byBlbWl0LlxuICAgKi9cbiAgcmVzdWx0U2VsZWN0b3I6IFJlc3VsdEZ1bmM8UywgVD47XG59XG5cbi8qKlxuICogR2VuZXJhdGVzIGFuIG9ic2VydmFibGUgc2VxdWVuY2UgYnkgcnVubmluZyBhIHN0YXRlLWRyaXZlbiBsb29wXG4gKiBwcm9kdWNpbmcgdGhlIHNlcXVlbmNlJ3MgZWxlbWVudHMsIHVzaW5nIHRoZSBzcGVjaWZpZWQgc2NoZWR1bGVyXG4gKiB0byBzZW5kIG91dCBvYnNlcnZlciBtZXNzYWdlcy5cbiAqXG4gKiAhW10oZ2VuZXJhdGUucG5nKVxuICpcbiAqIEBleGFtcGxlIDxjYXB0aW9uPlByb2R1Y2VzIHNlcXVlbmNlIG9mIDAsIDEsIDIsIC4uLiA5LCB0aGVuIGNvbXBsZXRlcy48L2NhcHRpb24+XG4gKiBjb25zdCByZXMgPSBnZW5lcmF0ZSgwLCB4ID0+IHggPCAxMCwgeCA9PiB4ICsgMSwgeCA9PiB4KTtcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5Vc2luZyBhc2FwIHNjaGVkdWxlciwgcHJvZHVjZXMgc2VxdWVuY2Ugb2YgMiwgMywgNSwgdGhlbiBjb21wbGV0ZXMuPC9jYXB0aW9uPlxuICogY29uc3QgcmVzID0gZ2VuZXJhdGUoMSwgeCA9PiB4IDwgNSwgeCA9PiAgKiAyLCB4ID0+IHggKyAxLCBhc2FwKTtcbiAqXG4gKiBAc2VlIHtAbGluayBmcm9tfVxuICogQHNlZSB7QGxpbmsgT2JzZXJ2YWJsZX1cbiAqXG4gKiBAcGFyYW0ge1N9IGluaXRpYWxTdGF0ZSBJbml0aWFsIHN0YXRlLlxuICogQHBhcmFtIHtmdW5jdGlvbiAoc3RhdGU6IFMpOiBib29sZWFufSBjb25kaXRpb24gQ29uZGl0aW9uIHRvIHRlcm1pbmF0ZSBnZW5lcmF0aW9uICh1cG9uIHJldHVybmluZyBmYWxzZSkuXG4gKiBAcGFyYW0ge2Z1bmN0aW9uIChzdGF0ZTogUyk6IFN9IGl0ZXJhdGUgSXRlcmF0aW9uIHN0ZXAgZnVuY3Rpb24uXG4gKiBAcGFyYW0ge2Z1bmN0aW9uIChzdGF0ZTogUyk6IFR9IHJlc3VsdFNlbGVjdG9yIFNlbGVjdG9yIGZ1bmN0aW9uIGZvciByZXN1bHRzIHByb2R1Y2VkIGluIHRoZSBzZXF1ZW5jZS4gKGRlcHJlY2F0ZWQpXG4gKiBAcGFyYW0ge1NjaGVkdWxlckxpa2V9IFtzY2hlZHVsZXJdIEEge0BsaW5rIFNjaGVkdWxlckxpa2V9IG9uIHdoaWNoIHRvIHJ1biB0aGUgZ2VuZXJhdG9yIGxvb3AuIElmIG5vdCBwcm92aWRlZCwgZGVmYXVsdHMgdG8gZW1pdCBpbW1lZGlhdGVseS5cbiAqIEByZXR1cm5zIHtPYnNlcnZhYmxlPFQ+fSBUaGUgZ2VuZXJhdGVkIHNlcXVlbmNlLlxuICovXG4gIGV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZTxULCBTPihpbml0aWFsU3RhdGU6IFMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25kaXRpb246IENvbmRpdGlvbkZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRlOiBJdGVyYXRlRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdFNlbGVjdG9yOiBSZXN1bHRGdW5jPFMsIFQ+LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE9ic2VydmFibGU8VD47XG5cbi8qKlxuICogR2VuZXJhdGVzIGFuIE9ic2VydmFibGUgYnkgcnVubmluZyBhIHN0YXRlLWRyaXZlbiBsb29wXG4gKiB0aGF0IGVtaXRzIGFuIGVsZW1lbnQgb24gZWFjaCBpdGVyYXRpb24uXG4gKlxuICogPHNwYW4gY2xhc3M9XCJpbmZvcm1hbFwiPlVzZSBpdCBpbnN0ZWFkIG9mIG5leHRpbmcgdmFsdWVzIGluIGEgZm9yIGxvb3AuPC9zcGFuPlxuICpcbiAqIDxpbWcgc3JjPVwiLi9pbWcvZ2VuZXJhdGUucG5nXCIgd2lkdGg9XCIxMDAlXCI+XG4gKlxuICogYGdlbmVyYXRlYCBhbGxvd3MgeW91IHRvIGNyZWF0ZSBzdHJlYW0gb2YgdmFsdWVzIGdlbmVyYXRlZCB3aXRoIGEgbG9vcCB2ZXJ5IHNpbWlsYXIgdG9cbiAqIHRyYWRpdGlvbmFsIGZvciBsb29wLiBGaXJzdCBhcmd1bWVudCBvZiBgZ2VuZXJhdGVgIGlzIGEgYmVnaW5uaW5nIHZhbHVlLiBTZWNvbmQgYXJndW1lbnRcbiAqIGlzIGEgZnVuY3Rpb24gdGhhdCBhY2NlcHRzIHRoaXMgdmFsdWUgYW5kIHRlc3RzIGlmIHNvbWUgY29uZGl0aW9uIHN0aWxsIGhvbGRzLiBJZiBpdCBkb2VzLFxuICogbG9vcCBjb250aW51ZXMsIGlmIG5vdCwgaXQgc3RvcHMuIFRoaXJkIHZhbHVlIGlzIGEgZnVuY3Rpb24gd2hpY2ggdGFrZXMgcHJldmlvdXNseSBkZWZpbmVkXG4gKiB2YWx1ZSBhbmQgbW9kaWZpZXMgaXQgaW4gc29tZSB3YXkgb24gZWFjaCBpdGVyYXRpb24uIE5vdGUgaG93IHRoZXNlIHRocmVlIHBhcmFtZXRlcnNcbiAqIGFyZSBkaXJlY3QgZXF1aXZhbGVudHMgb2YgdGhyZWUgZXhwcmVzc2lvbnMgaW4gcmVndWxhciBmb3IgbG9vcDogZmlyc3QgZXhwcmVzc2lvblxuICogaW5pdGlhbGl6ZXMgc29tZSBzdGF0ZSAoZm9yIGV4YW1wbGUgbnVtZXJpYyBpbmRleCksIHNlY29uZCB0ZXN0cyBpZiBsb29wIGNhbiBtYWtlIG5leHRcbiAqIGl0ZXJhdGlvbiAoZm9yIGV4YW1wbGUgaWYgaW5kZXggaXMgbG93ZXIgdGhhbiAxMCkgYW5kIHRoaXJkIHN0YXRlcyBob3cgZGVmaW5lZCB2YWx1ZVxuICogd2lsbCBiZSBtb2RpZmllZCBvbiBldmVyeSBzdGVwIChpbmRleCB3aWxsIGJlIGluY3JlbWVudGVkIGJ5IG9uZSkuXG4gKlxuICogUmV0dXJuIHZhbHVlIG9mIGEgYGdlbmVyYXRlYCBvcGVyYXRvciBpcyBhbiBPYnNlcnZhYmxlIHRoYXQgb24gZWFjaCBsb29wIGl0ZXJhdGlvblxuICogZW1pdHMgYSB2YWx1ZS4gRmlyc3QsIGNvbmRpdGlvbiBmdW5jdGlvbiBpcyByYW4uIElmIGl0IHJldHVybmVkIHRydWUsIE9ic2VydmFibGVcbiAqIGVtaXRzIGN1cnJlbnRseSBzdG9yZWQgdmFsdWUgKGluaXRpYWwgdmFsdWUgYXQgdGhlIGZpcnN0IGl0ZXJhdGlvbikgYW5kIHRoZW4gdXBkYXRlc1xuICogdGhhdCB2YWx1ZSB3aXRoIGl0ZXJhdGUgZnVuY3Rpb24uIElmIGF0IHNvbWUgcG9pbnQgY29uZGl0aW9uIHJldHVybmVkIGZhbHNlLCBPYnNlcnZhYmxlXG4gKiBjb21wbGV0ZXMgYXQgdGhhdCBtb21lbnQuXG4gKlxuICogT3B0aW9uYWxseSB5b3UgY2FuIHBhc3MgZm91cnRoIHBhcmFtZXRlciB0byBgZ2VuZXJhdGVgIC0gYSByZXN1bHQgc2VsZWN0b3IgZnVuY3Rpb24gd2hpY2ggYWxsb3dzIHlvdVxuICogdG8gaW1tZWRpYXRlbHkgbWFwIHZhbHVlIHRoYXQgd291bGQgbm9ybWFsbHkgYmUgZW1pdHRlZCBieSBhbiBPYnNlcnZhYmxlLlxuICpcbiAqIElmIHlvdSBmaW5kIHRocmVlIGFub255bW91cyBmdW5jdGlvbnMgaW4gYGdlbmVyYXRlYCBjYWxsIGhhcmQgdG8gcmVhZCwgeW91IGNhbiBwcm92aWRlXG4gKiBzaW5nbGUgb2JqZWN0IHRvIHRoZSBvcGVyYXRvciBpbnN0ZWFkLiBUaGF0IG9iamVjdCBoYXMgcHJvcGVydGllczogYGluaXRpYWxTdGF0ZWAsXG4gKiBgY29uZGl0aW9uYCwgYGl0ZXJhdGVgIGFuZCBgcmVzdWx0U2VsZWN0b3JgLCB3aGljaCBzaG91bGQgaGF2ZSByZXNwZWN0aXZlIHZhbHVlcyB0aGF0IHlvdVxuICogd291bGQgbm9ybWFsbHkgcGFzcyB0byBgZ2VuZXJhdGVgLiBgcmVzdWx0U2VsZWN0b3JgIGlzIHN0aWxsIG9wdGlvbmFsLCBidXQgdGhhdCBmb3JtXG4gKiBvZiBjYWxsaW5nIGBnZW5lcmF0ZWAgYWxsb3dzIHlvdSB0byBvbWl0IGBjb25kaXRpb25gIGFzIHdlbGwuIElmIHlvdSBvbWl0IGl0LCB0aGF0IG1lYW5zXG4gKiBjb25kaXRpb24gYWx3YXlzIGhvbGRzLCBzbyBvdXRwdXQgT2JzZXJ2YWJsZSB3aWxsIG5ldmVyIGNvbXBsZXRlLlxuICpcbiAqIEJvdGggZm9ybXMgb2YgYGdlbmVyYXRlYCBjYW4gb3B0aW9uYWxseSBhY2NlcHQgYSBzY2hlZHVsZXIuIEluIGNhc2Ugb2YgbXVsdGktcGFyYW1ldGVyIGNhbGwsXG4gKiBzY2hlZHVsZXIgc2ltcGx5IGNvbWVzIGFzIGEgbGFzdCBhcmd1bWVudCAobm8gbWF0dGVyIGlmIHRoZXJlIGlzIHJlc3VsdFNlbGVjdG9yXG4gKiBmdW5jdGlvbiBvciBub3QpLiBJbiBjYXNlIG9mIHNpbmdsZS1wYXJhbWV0ZXIgY2FsbCwgeW91IGNhbiBwcm92aWRlIGl0IGFzIGFcbiAqIGBzY2hlZHVsZXJgIHByb3BlcnR5IG9uIG9iamVjdCBwYXNzZWQgdG8gdGhlIG9wZXJhdG9yLiBJbiBib3RoIGNhc2VzIHNjaGVkdWxlciBkZWNpZGVzIHdoZW5cbiAqIG5leHQgaXRlcmF0aW9uIG9mIHRoZSBsb29wIHdpbGwgaGFwcGVuIGFuZCB0aGVyZWZvcmUgd2hlbiBuZXh0IHZhbHVlIHdpbGwgYmUgZW1pdHRlZFxuICogYnkgdGhlIE9ic2VydmFibGUuIEZvciBleGFtcGxlIHRvIGVuc3VyZSB0aGF0IGVhY2ggdmFsdWUgaXMgcHVzaGVkIHRvIHRoZSBvYnNlcnZlclxuICogb24gc2VwYXJhdGUgdGFzayBpbiBldmVudCBsb29wLCB5b3UgY291bGQgdXNlIGBhc3luY2Agc2NoZWR1bGVyLiBOb3RlIHRoYXRcbiAqIGJ5IGRlZmF1bHQgKHdoZW4gbm8gc2NoZWR1bGVyIGlzIHBhc3NlZCkgdmFsdWVzIGFyZSBzaW1wbHkgZW1pdHRlZCBzeW5jaHJvbm91c2x5LlxuICpcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5Vc2Ugd2l0aCBjb25kaXRpb24gYW5kIGl0ZXJhdGUgZnVuY3Rpb25zLjwvY2FwdGlvbj5cbiAqIGNvbnN0IGdlbmVyYXRlZCA9IGdlbmVyYXRlKDAsIHggPT4geCA8IDMsIHggPT4geCArIDEpO1xuICpcbiAqIGdlbmVyYXRlZC5zdWJzY3JpYmUoXG4gKiAgIHZhbHVlID0+IGNvbnNvbGUubG9nKHZhbHVlKSxcbiAqICAgZXJyID0+IHt9LFxuICogICAoKSA9PiBjb25zb2xlLmxvZygnWW8hJylcbiAqICk7XG4gKlxuICogLy8gTG9nczpcbiAqIC8vIDBcbiAqIC8vIDFcbiAqIC8vIDJcbiAqIC8vIFwiWW8hXCJcbiAqXG4gKlxuICogQGV4YW1wbGUgPGNhcHRpb24+VXNlIHdpdGggY29uZGl0aW9uLCBpdGVyYXRlIGFuZCByZXN1bHRTZWxlY3RvciBmdW5jdGlvbnMuPC9jYXB0aW9uPlxuICogY29uc3QgZ2VuZXJhdGVkID0gZ2VuZXJhdGUoMCwgeCA9PiB4IDwgMywgeCA9PiB4ICsgMSwgeCA9PiB4ICogMTAwMCk7XG4gKlxuICogZ2VuZXJhdGVkLnN1YnNjcmliZShcbiAqICAgdmFsdWUgPT4gY29uc29sZS5sb2codmFsdWUpLFxuICogICBlcnIgPT4ge30sXG4gKiAgICgpID0+IGNvbnNvbGUubG9nKCdZbyEnKVxuICogKTtcbiAqXG4gKiAvLyBMb2dzOlxuICogLy8gMFxuICogLy8gMTAwMFxuICogLy8gMjAwMFxuICogLy8gXCJZbyFcIlxuICpcbiAqXG4gKiBAZXhhbXBsZSA8Y2FwdGlvbj5Vc2Ugd2l0aCBvcHRpb25zIG9iamVjdC48L2NhcHRpb24+XG4gKiBjb25zdCBnZW5lcmF0ZWQgPSBnZW5lcmF0ZSh7XG4gKiAgIGluaXRpYWxTdGF0ZTogMCxcbiAqICAgY29uZGl0aW9uKHZhbHVlKSB7IHJldHVybiB2YWx1ZSA8IDM7IH0sXG4gKiAgIGl0ZXJhdGUodmFsdWUpIHsgcmV0dXJuIHZhbHVlICsgMTsgfSxcbiAqICAgcmVzdWx0U2VsZWN0b3IodmFsdWUpIHsgcmV0dXJuIHZhbHVlICogMTAwMDsgfVxuICogfSk7XG4gKlxuICogZ2VuZXJhdGVkLnN1YnNjcmliZShcbiAqICAgdmFsdWUgPT4gY29uc29sZS5sb2codmFsdWUpLFxuICogICBlcnIgPT4ge30sXG4gKiAgICgpID0+IGNvbnNvbGUubG9nKCdZbyEnKVxuICogKTtcbiAqXG4gKiAvLyBMb2dzOlxuICogLy8gMFxuICogLy8gMTAwMFxuICogLy8gMjAwMFxuICogLy8gXCJZbyFcIlxuICpcbiAqIEBleGFtcGxlIDxjYXB0aW9uPlVzZSBvcHRpb25zIG9iamVjdCB3aXRob3V0IGNvbmRpdGlvbiBmdW5jdGlvbi48L2NhcHRpb24+XG4gKiBjb25zdCBnZW5lcmF0ZWQgPSBnZW5lcmF0ZSh7XG4gKiAgIGluaXRpYWxTdGF0ZTogMCxcbiAqICAgaXRlcmF0ZSh2YWx1ZSkgeyByZXR1cm4gdmFsdWUgKyAxOyB9LFxuICogICByZXN1bHRTZWxlY3Rvcih2YWx1ZSkgeyByZXR1cm4gdmFsdWUgKiAxMDAwOyB9XG4gKiB9KTtcbiAqXG4gKiBnZW5lcmF0ZWQuc3Vic2NyaWJlKFxuICogICB2YWx1ZSA9PiBjb25zb2xlLmxvZyh2YWx1ZSksXG4gKiAgIGVyciA9PiB7fSxcbiAqICAgKCkgPT4gY29uc29sZS5sb2coJ1lvIScpIC8vIFRoaXMgd2lsbCBuZXZlciBydW4uXG4gKiApO1xuICpcbiAqIC8vIExvZ3M6XG4gKiAvLyAwXG4gKiAvLyAxMDAwXG4gKiAvLyAyMDAwXG4gKiAvLyAzMDAwXG4gKiAvLyAuLi5hbmQgbmV2ZXIgc3RvcHMuXG4gKlxuICpcbiAqIEBzZWUge0BsaW5rIGZyb219XG4gKiBAc2VlIHtAbGluayBjcmVhdGV9XG4gKlxuICogQHBhcmFtIHtTfSBpbml0aWFsU3RhdGUgSW5pdGlhbCBzdGF0ZS5cbiAqIEBwYXJhbSB7ZnVuY3Rpb24gKHN0YXRlOiBTKTogYm9vbGVhbn0gY29uZGl0aW9uIENvbmRpdGlvbiB0byB0ZXJtaW5hdGUgZ2VuZXJhdGlvbiAodXBvbiByZXR1cm5pbmcgZmFsc2UpLlxuICogQHBhcmFtIHtmdW5jdGlvbiAoc3RhdGU6IFMpOiBTfSBpdGVyYXRlIEl0ZXJhdGlvbiBzdGVwIGZ1bmN0aW9uLlxuICogQHBhcmFtIHtmdW5jdGlvbiAoc3RhdGU6IFMpOiBUfSBbcmVzdWx0U2VsZWN0b3JdIFNlbGVjdG9yIGZ1bmN0aW9uIGZvciByZXN1bHRzIHByb2R1Y2VkIGluIHRoZSBzZXF1ZW5jZS5cbiAqIEBwYXJhbSB7U2NoZWR1bGVyfSBbc2NoZWR1bGVyXSBBIHtAbGluayBTY2hlZHVsZXJ9IG9uIHdoaWNoIHRvIHJ1biB0aGUgZ2VuZXJhdG9yIGxvb3AuIElmIG5vdCBwcm92aWRlZCwgZGVmYXVsdHMgdG8gZW1pdHRpbmcgaW1tZWRpYXRlbHkuXG4gKiBAcmV0dXJuIHtPYnNlcnZhYmxlPFQ+fSBUaGUgZ2VuZXJhdGVkIHNlcXVlbmNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2VuZXJhdGU8Uz4oaW5pdGlhbFN0YXRlOiBTLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmRpdGlvbjogQ29uZGl0aW9uRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRlOiBJdGVyYXRlRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY2hlZHVsZXI/OiBTY2hlZHVsZXJMaWtlKTogT2JzZXJ2YWJsZTxTPjtcblxuLyoqXG4gKiBHZW5lcmF0ZXMgYW4gb2JzZXJ2YWJsZSBzZXF1ZW5jZSBieSBydW5uaW5nIGEgc3RhdGUtZHJpdmVuIGxvb3BcbiAqIHByb2R1Y2luZyB0aGUgc2VxdWVuY2UncyBlbGVtZW50cywgdXNpbmcgdGhlIHNwZWNpZmllZCBzY2hlZHVsZXJcbiAqIHRvIHNlbmQgb3V0IG9ic2VydmVyIG1lc3NhZ2VzLlxuICogVGhlIG92ZXJsb2FkIGFjY2VwdHMgb3B0aW9ucyBvYmplY3QgdGhhdCBtaWdodCBjb250YWluIGluaXRpYWwgc3RhdGUsIGl0ZXJhdGUsXG4gKiBjb25kaXRpb24gYW5kIHNjaGVkdWxlci5cbiAqXG4gKiAhW10oZ2VuZXJhdGUucG5nKVxuICpcbiAqIEBleGFtcGxlIDxjYXB0aW9uPlByb2R1Y2VzIHNlcXVlbmNlIG9mIDAsIDEsIDIsIC4uLiA5LCB0aGVuIGNvbXBsZXRlcy48L2NhcHRpb24+XG4gKiBjb25zdCByZXMgPSBnZW5lcmF0ZSh7XG4gKiAgIGluaXRpYWxTdGF0ZTogMCxcbiAqICAgY29uZGl0aW9uOiB4ID0+IHggPCAxMCxcbiAqICAgaXRlcmF0ZTogeCA9PiB4ICsgMSxcbiAqIH0pO1xuICpcbiAqIEBzZWUge0BsaW5rIGZyb219XG4gKiBAc2VlIHtAbGluayBPYnNlcnZhYmxlfVxuICpcbiAqIEBwYXJhbSB7R2VuZXJhdGVCYXNlT3B0aW9uczxTPn0gb3B0aW9ucyBPYmplY3QgdGhhdCBtdXN0IGNvbnRhaW4gaW5pdGlhbFN0YXRlLCBpdGVyYXRlIGFuZCBtaWdodCBjb250YWluIGNvbmRpdGlvbiBhbmQgc2NoZWR1bGVyLlxuICogQHJldHVybnMge09ic2VydmFibGU8Uz59IFRoZSBnZW5lcmF0ZWQgc2VxdWVuY2UuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZTxTPihvcHRpb25zOiBHZW5lcmF0ZUJhc2VPcHRpb25zPFM+KTogT2JzZXJ2YWJsZTxTPjtcblxuLyoqXG4gKiBHZW5lcmF0ZXMgYW4gb2JzZXJ2YWJsZSBzZXF1ZW5jZSBieSBydW5uaW5nIGEgc3RhdGUtZHJpdmVuIGxvb3BcbiAqIHByb2R1Y2luZyB0aGUgc2VxdWVuY2UncyBlbGVtZW50cywgdXNpbmcgdGhlIHNwZWNpZmllZCBzY2hlZHVsZXJcbiAqIHRvIHNlbmQgb3V0IG9ic2VydmVyIG1lc3NhZ2VzLlxuICogVGhlIG92ZXJsb2FkIGFjY2VwdHMgb3B0aW9ucyBvYmplY3QgdGhhdCBtaWdodCBjb250YWluIGluaXRpYWwgc3RhdGUsIGl0ZXJhdGUsXG4gKiBjb25kaXRpb24sIHJlc3VsdCBzZWxlY3RvciBhbmQgc2NoZWR1bGVyLlxuICpcbiAqICFbXShnZW5lcmF0ZS5wbmcpXG4gKlxuICogQGV4YW1wbGUgPGNhcHRpb24+UHJvZHVjZXMgc2VxdWVuY2Ugb2YgMCwgMSwgMiwgLi4uIDksIHRoZW4gY29tcGxldGVzLjwvY2FwdGlvbj5cbiAqIGNvbnN0IHJlcyA9IGdlbmVyYXRlKHtcbiAqICAgaW5pdGlhbFN0YXRlOiAwLFxuICogICBjb25kaXRpb246IHggPT4geCA8IDEwLFxuICogICBpdGVyYXRlOiB4ID0+IHggKyAxLFxuICogICByZXN1bHRTZWxlY3RvcjogeCA9PiB4LFxuICogfSk7XG4gKlxuICogQHNlZSB7QGxpbmsgZnJvbX1cbiAqIEBzZWUge0BsaW5rIE9ic2VydmFibGV9XG4gKlxuICogQHBhcmFtIHtHZW5lcmF0ZU9wdGlvbnM8VCwgUz59IG9wdGlvbnMgT2JqZWN0IHRoYXQgbXVzdCBjb250YWluIGluaXRpYWxTdGF0ZSwgaXRlcmF0ZSwgcmVzdWx0U2VsZWN0b3IgYW5kIG1pZ2h0IGNvbnRhaW4gY29uZGl0aW9uIGFuZCBzY2hlZHVsZXIuXG4gKiBAcmV0dXJucyB7T2JzZXJ2YWJsZTxUPn0gVGhlIGdlbmVyYXRlZCBzZXF1ZW5jZS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdlbmVyYXRlPFQsIFM+KG9wdGlvbnM6IEdlbmVyYXRlT3B0aW9uczxULCBTPik6IE9ic2VydmFibGU8VD47XG5cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZTxULCBTPihpbml0aWFsU3RhdGVPck9wdGlvbnM6IFMgfCBHZW5lcmF0ZU9wdGlvbnM8VCwgUz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZGl0aW9uPzogQ29uZGl0aW9uRnVuYzxTPixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVyYXRlPzogSXRlcmF0ZUZ1bmM8Uz4sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGU/OiAoUmVzdWx0RnVuYzxTLCBUPikgfCBTY2hlZHVsZXJMaWtlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjaGVkdWxlcj86IFNjaGVkdWxlckxpa2UpOiBPYnNlcnZhYmxlPFQ+IHtcblxuICBsZXQgcmVzdWx0U2VsZWN0b3I6IFJlc3VsdEZ1bmM8UywgVD47XG4gIGxldCBpbml0aWFsU3RhdGU6IFM7XG5cbiAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMSkge1xuICAgIGNvbnN0IG9wdGlvbnMgPSBpbml0aWFsU3RhdGVPck9wdGlvbnMgYXMgR2VuZXJhdGVPcHRpb25zPFQsIFM+O1xuICAgIGluaXRpYWxTdGF0ZSA9IG9wdGlvbnMuaW5pdGlhbFN0YXRlO1xuICAgIGNvbmRpdGlvbiA9IG9wdGlvbnMuY29uZGl0aW9uO1xuICAgIGl0ZXJhdGUgPSBvcHRpb25zLml0ZXJhdGU7XG4gICAgcmVzdWx0U2VsZWN0b3IgPSBvcHRpb25zLnJlc3VsdFNlbGVjdG9yIHx8IGlkZW50aXR5IGFzIFJlc3VsdEZ1bmM8UywgVD47XG4gICAgc2NoZWR1bGVyID0gb3B0aW9ucy5zY2hlZHVsZXI7XG4gIH0gZWxzZSBpZiAocmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGUgPT09IHVuZGVmaW5lZCB8fCBpc1NjaGVkdWxlcihyZXN1bHRTZWxlY3Rvck9yT2JzZXJ2YWJsZSkpIHtcbiAgICBpbml0aWFsU3RhdGUgPSBpbml0aWFsU3RhdGVPck9wdGlvbnMgYXMgUztcbiAgICByZXN1bHRTZWxlY3RvciA9IGlkZW50aXR5IGFzIFJlc3VsdEZ1bmM8UywgVD47XG4gICAgc2NoZWR1bGVyID0gcmVzdWx0U2VsZWN0b3JPck9ic2VydmFibGUgYXMgU2NoZWR1bGVyTGlrZTtcbiAgfSBlbHNlIHtcbiAgICBpbml0aWFsU3RhdGUgPSBpbml0aWFsU3RhdGVPck9wdGlvbnMgYXMgUztcbiAgICByZXN1bHRTZWxlY3RvciA9IHJlc3VsdFNlbGVjdG9yT3JPYnNlcnZhYmxlIGFzIFJlc3VsdEZ1bmM8UywgVD47XG4gIH1cblxuICByZXR1cm4gbmV3IE9ic2VydmFibGU8VD4oc3Vic2NyaWJlciA9PiB7XG4gICAgbGV0IHN0YXRlID0gaW5pdGlhbFN0YXRlO1xuICAgIGlmIChzY2hlZHVsZXIpIHtcbiAgICAgIHJldHVybiBzY2hlZHVsZXIuc2NoZWR1bGU8U2NoZWR1bGVyU3RhdGU8VCwgUz4+KGRpc3BhdGNoLCAwLCB7XG4gICAgICAgIHN1YnNjcmliZXIsXG4gICAgICAgIGl0ZXJhdGUsXG4gICAgICAgIGNvbmRpdGlvbixcbiAgICAgICAgcmVzdWx0U2VsZWN0b3IsXG4gICAgICAgIHN0YXRlXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBkbyB7XG4gICAgICBpZiAoY29uZGl0aW9uKSB7XG4gICAgICAgIGxldCBjb25kaXRpb25SZXN1bHQ6IGJvb2xlYW47XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uZGl0aW9uUmVzdWx0ID0gY29uZGl0aW9uKHN0YXRlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgc3Vic2NyaWJlci5lcnJvcihlcnIpO1xuICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFjb25kaXRpb25SZXN1bHQpIHtcbiAgICAgICAgICBzdWJzY3JpYmVyLmNvbXBsZXRlKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGxldCB2YWx1ZTogVDtcbiAgICAgIHRyeSB7XG4gICAgICAgIHZhbHVlID0gcmVzdWx0U2VsZWN0b3Ioc3RhdGUpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHN1YnNjcmliZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICAgIHN1YnNjcmliZXIubmV4dCh2YWx1ZSk7XG4gICAgICBpZiAoc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBzdGF0ZSA9IGl0ZXJhdGUoc3RhdGUpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHN1YnNjcmliZXIuZXJyb3IoZXJyKTtcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgIH1cbiAgICB9IHdoaWxlICh0cnVlKTtcblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBkaXNwYXRjaDxULCBTPih0aGlzOiBTY2hlZHVsZXJBY3Rpb248U2NoZWR1bGVyU3RhdGU8VCwgUz4+LCBzdGF0ZTogU2NoZWR1bGVyU3RhdGU8VCwgUz4pIHtcbiAgY29uc3QgeyBzdWJzY3JpYmVyLCBjb25kaXRpb24gfSA9IHN0YXRlO1xuICBpZiAoc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIGlmIChzdGF0ZS5uZWVkSXRlcmF0ZSkge1xuICAgIHRyeSB7XG4gICAgICBzdGF0ZS5zdGF0ZSA9IHN0YXRlLml0ZXJhdGUoc3RhdGUuc3RhdGUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgc3Vic2NyaWJlci5lcnJvcihlcnIpO1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc3RhdGUubmVlZEl0ZXJhdGUgPSB0cnVlO1xuICB9XG4gIGlmIChjb25kaXRpb24pIHtcbiAgICBsZXQgY29uZGl0aW9uUmVzdWx0OiBib29sZWFuO1xuICAgIHRyeSB7XG4gICAgICBjb25kaXRpb25SZXN1bHQgPSBjb25kaXRpb24oc3RhdGUuc3RhdGUpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgc3Vic2NyaWJlci5lcnJvcihlcnIpO1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gICAgaWYgKCFjb25kaXRpb25SZXN1bHQpIHtcbiAgICAgIHN1YnNjcmliZXIuY29tcGxldGUoKTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICAgIGlmIChzdWJzY3JpYmVyLmNsb3NlZCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cbiAgbGV0IHZhbHVlOiBUO1xuICB0cnkge1xuICAgIHZhbHVlID0gc3RhdGUucmVzdWx0U2VsZWN0b3Ioc3RhdGUuc3RhdGUpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBzdWJzY3JpYmVyLmVycm9yKGVycik7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBpZiAoc3Vic2NyaWJlci5jbG9zZWQpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG4gIHN1YnNjcmliZXIubmV4dCh2YWx1ZSk7XG4gIGlmIChzdWJzY3JpYmVyLmNsb3NlZCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgcmV0dXJuIHRoaXMuc2NoZWR1bGUoc3RhdGUpO1xufVxuIl19