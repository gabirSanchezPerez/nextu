"use strict";
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
Object.defineProperty(exports, "__esModule", { value: true });
var events_1 = require("../common/events");
var utils_1 = require("../common/utils");
var property_descriptor_1 = require("./property-descriptor");
function eventTargetPatch(_global, api) {
    var WTF_ISSUE_555 = 'Anchor,Area,Audio,BR,Base,BaseFont,Body,Button,Canvas,Content,DList,Directory,Div,Embed,FieldSet,Font,Form,Frame,FrameSet,HR,Head,Heading,Html,IFrame,Image,Input,Keygen,LI,Label,Legend,Link,Map,Marquee,Media,Menu,Meta,Meter,Mod,OList,Object,OptGroup,Option,Output,Paragraph,Pre,Progress,Quote,Script,Select,Source,Span,Style,TableCaption,TableCell,TableCol,Table,TableRow,TableSection,TextArea,Title,Track,UList,Unknown,Video';
    var NO_EVENT_TARGET = 'ApplicationCache,EventSource,FileReader,InputMethodContext,MediaController,MessagePort,Node,Performance,SVGElementInstance,SharedWorker,TextTrack,TextTrackCue,TextTrackList,WebKitNamedFlow,Window,Worker,WorkerGlobalScope,XMLHttpRequest,XMLHttpRequestEventTarget,XMLHttpRequestUpload,IDBRequest,IDBOpenDBRequest,IDBDatabase,IDBTransaction,IDBCursor,DBIndex,WebSocket'
        .split(',');
    var EVENT_TARGET = 'EventTarget';
    var apis = [];
    var isWtf = _global['wtf'];
    var WTF_ISSUE_555_ARRAY = WTF_ISSUE_555.split(',');
    if (isWtf) {
        // Workaround for: https://github.com/google/tracing-framework/issues/555
        apis = WTF_ISSUE_555_ARRAY.map(function (v) { return 'HTML' + v + 'Element'; }).concat(NO_EVENT_TARGET);
    }
    else if (_global[EVENT_TARGET]) {
        apis.push(EVENT_TARGET);
    }
    else {
        // Note: EventTarget is not available in all browsers,
        // if it's not available, we instead patch the APIs in the IDL that inherit from EventTarget
        apis = NO_EVENT_TARGET;
    }
    var isDisableIECheck = _global['__Zone_disable_IE_check'] || false;
    var isEnableCrossContextCheck = _global['__Zone_enable_cross_context_check'] || false;
    var ieOrEdge = utils_1.isIEOrEdge();
    var ADD_EVENT_LISTENER_SOURCE = '.addEventListener:';
    var FUNCTION_WRAPPER = '[object FunctionWrapper]';
    var BROWSER_TOOLS = 'function __BROWSERTOOLS_CONSOLE_SAFEFUNC() { [native code] }';
    //  predefine all __zone_symbol__ + eventName + true/false string
    for (var i = 0; i < property_descriptor_1.eventNames.length; i++) {
        var eventName = property_descriptor_1.eventNames[i];
        var falseEventName = eventName + utils_1.FALSE_STR;
        var trueEventName = eventName + utils_1.TRUE_STR;
        var symbol = utils_1.ZONE_SYMBOL_PREFIX + falseEventName;
        var symbolCapture = utils_1.ZONE_SYMBOL_PREFIX + trueEventName;
        events_1.zoneSymbolEventNames[eventName] = {};
        events_1.zoneSymbolEventNames[eventName][utils_1.FALSE_STR] = symbol;
        events_1.zoneSymbolEventNames[eventName][utils_1.TRUE_STR] = symbolCapture;
    }
    //  predefine all task.source string
    for (var i = 0; i < WTF_ISSUE_555.length; i++) {
        var target = WTF_ISSUE_555_ARRAY[i];
        var targets = events_1.globalSources[target] = {};
        for (var j = 0; j < property_descriptor_1.eventNames.length; j++) {
            var eventName = property_descriptor_1.eventNames[j];
            targets[eventName] = target + ADD_EVENT_LISTENER_SOURCE + eventName;
        }
    }
    var checkIEAndCrossContext = function (nativeDelegate, delegate, target, args) {
        if (!isDisableIECheck && ieOrEdge) {
            if (isEnableCrossContextCheck) {
                try {
                    var testString = delegate.toString();
                    if ((testString === FUNCTION_WRAPPER || testString == BROWSER_TOOLS)) {
                        nativeDelegate.apply(target, args);
                        return false;
                    }
                }
                catch (error) {
                    nativeDelegate.apply(target, args);
                    return false;
                }
            }
            else {
                var testString = delegate.toString();
                if ((testString === FUNCTION_WRAPPER || testString == BROWSER_TOOLS)) {
                    nativeDelegate.apply(target, args);
                    return false;
                }
            }
        }
        else if (isEnableCrossContextCheck) {
            try {
                delegate.toString();
            }
            catch (error) {
                nativeDelegate.apply(target, args);
                return false;
            }
        }
        return true;
    };
    var apiTypes = [];
    for (var i = 0; i < apis.length; i++) {
        var type = _global[apis[i]];
        apiTypes.push(type && type.prototype);
    }
    // vh is validateHandler to check event handler
    // is valid or not(for security check)
    events_1.patchEventTarget(_global, apiTypes, { vh: checkIEAndCrossContext });
    api.patchEventTarget = events_1.patchEventTarget;
    return true;
}
exports.eventTargetPatch = eventTargetPatch;
function patchEvent(global, api) {
    events_1.patchEventPrototype(global, api);
}
exports.patchEvent = patchEvent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQtdGFyZ2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXZlbnQtdGFyZ2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7O0dBTUc7O0FBRUgsMkNBQTRHO0FBQzVHLHlDQUFvRjtBQUVwRiw2REFBaUQ7QUFFakQsU0FBZ0IsZ0JBQWdCLENBQUMsT0FBWSxFQUFFLEdBQWlCO0lBQzlELElBQU0sYUFBYSxHQUNmLDJhQUEyYSxDQUFDO0lBQ2hiLElBQU0sZUFBZSxHQUNqQiwrV0FBK1c7U0FDMVcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3BCLElBQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQztJQUVuQyxJQUFJLElBQUksR0FBRyxFQUFFLENBQUM7SUFDZCxJQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsSUFBTSxtQkFBbUIsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRXJELElBQUksS0FBSyxFQUFFO1FBQ1QseUVBQXlFO1FBQ3pFLElBQUksR0FBRyxtQkFBbUIsQ0FBQyxHQUFHLENBQUMsVUFBQyxDQUFDLElBQUssT0FBQSxNQUFNLEdBQUcsQ0FBQyxHQUFHLFNBQVMsRUFBdEIsQ0FBc0IsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQztLQUN2RjtTQUFNLElBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxFQUFFO1FBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7S0FDekI7U0FBTTtRQUNMLHNEQUFzRDtRQUN0RCw0RkFBNEY7UUFDNUYsSUFBSSxHQUFHLGVBQWUsQ0FBQztLQUN4QjtJQUVELElBQU0sZ0JBQWdCLEdBQUcsT0FBTyxDQUFDLHlCQUF5QixDQUFDLElBQUksS0FBSyxDQUFDO0lBQ3JFLElBQU0seUJBQXlCLEdBQUcsT0FBTyxDQUFDLG1DQUFtQyxDQUFDLElBQUksS0FBSyxDQUFDO0lBQ3hGLElB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Q25DLE9BQU8sS0FBSyxDQUFDO2FBQ2Q7U0FDRjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFDO0lBRUYsSUFBTSxRQUFRLEdBQVUsRUFBRSxDQUFDO0lBQzNCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3BDLElBQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7S0FDdkM7SUFDRCwrQ0FBK0M7SUFDL0Msc0NBQXNDO0lBQ3RDLHlCQUFnQixDQUFDLE9BQU8sRUFBRSxRQUFRLEVBQUUsRUFBQyxFQUFFLEVBQUUsc0JBQXNCLEVBQUMsQ0FBQyxDQUFDO0lBQ2xFLEdBQUcsQ0FBQyxnQkFBZ0IsR0FBRyx5QkFBZ0IsQ0FBQztJQUV4QyxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFoR0QsNENBZ0dDO0FBRUQsU0FBZ0IsVUFBVSxDQUFDLE1BQVcsRUFBRSxHQUFpQjtJQUN2RCw0QkFBbUIsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDbkMsQ0FBQztBQUZELGdDQUVDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBJbmMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcbiAqIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgYXQgaHR0cHM6Ly9hbmd1bGFyLmlvL2xpY2Vuc2VcbiAqL1xuXG5pbXBvcnQge2dsb2JhbFNvdXJjZXMsIHBhdGNoRXZlbnRQcm90b3R5cGUsIHBhdGNoRXZlbnRUYXJnZXQsIHpvbmVTeW1ib2xFdmVudE5hbWVzfSBmcm9tICcuLi9jb21tb24vZXZlbnRzJztcbmltcG9ydCB7RkFMU0VfU1RSLCBpc0lFT3JFZGdlLCBUUlVFX1NUUiwgWk9ORV9TWU1CT0xfUFJFRklYfSBmcm9tICcuLi9jb21tb24vdXRpbHMnO1xuXG5pbXBvcnQge2V2ZW50TmFtZXN9IGZyb20gJy4vcHJvcGVydHktZGVzY3JpcHRvcic7XG5cbmV4cG9ydCBmdW5jdGlvbiBldmVudFRhcmdldFBhdGNoKF9nbG9iYWw6IGFueSwgYXBpOiBfWm9uZVByaXZhdGUpIHtcbiAgY29uc3QgV1RGX0lTU1VFXzU1NSA9XG4gICAgICAnQW5jaG9yLEFyZWEsQXVkaW8sQlIsQmFzZSxCYXNlRm9udCxCb2R5LEJ1dHRvbixDYW52YXMsQ29udGVudCxETGlzdCxEaXJlY3RvcnksRGl2LEVtYmVkLEZpZWxkU2V0LEZvbnQsRm9ybSxGcmFtZSxGcmFtZVNldCxIUixIZWFkLEhlYWRpbmcsSHRtbCxJRnJhbWUsSW1hZ2UsSW5wdXQsS2V5Z2VuLExJLExhYmVsLExlZ2VuZCxMaW5rLE1hcCxNYXJxdWVlLE1lZGlhLE1lbnUsTWV0YSxNZXRlcixNb2QsT0xpc3QsT2JqZWN0LE9wdEdyb3VwLE9wdGlvbixPdXRwdXQsUGFyYWdyYXBoLFByZSxQcm9ncmVzcyxRdW90ZSxTY3JpcHQsU2VsZWN0LFNvdXJjZSxTcGFuLFN0eWxlLFRhYmxlQ2FwdGlvbixUYWJsZUNlbGwsVGFibGVDb2wsVGFibGUsVGFibGVSb3csVGFibGVTZWN0aW9uLFRleHRBcmVhLFRpdGxlLFRyYWNrLFVMaXN0LFVua25vd24sVmlkZW8nO1xuICBjb25zdCBOT19FVkVOVF9UQVJHRVQgPVxuICAgICAgJ0FwcGxpY2F0aW9uQ2FjaGUsRXZlbnRTb3VyY2UsRmlsZVJlYWRlcixJbnB1dE1ldGhvZENvbnRleHQsTWVkaWFDb250cm9sbGVyLE1lc3NhZ2VQb3J0LE5vZGUsUGVyZm9ybWFuY2UsU1ZHRWxlbWVudEluc3RhbmNlLFNoYXJlZFdvcmtlcixUZXh0VHJhY2ssVGV4dFRyYWNrQ3VlLFRleHRUcmFja0xpc3QsV2ViS2l0TmFtZWRGbG93LFdpbmRvdyxXb3JrZXIsV29ya2VyR2xvYmFsU2NvcGUsWE1MSHR0cFJlcXVlc3QsWE1MSHR0cFJlcXVlc3RFdmVudFRhcmdldCxYTUxIdHRwUmVxdWVzdFVwbG9hZCxJREJSZXF1ZXN0LElEQk9wZW5EQlJlcXVlc3QsSURCRGF0YWJhc2UsSURCVHJhbnNhY3Rpb24sSURCQ3Vyc29yLERCSW5kZXgsV2ViU29ja2V0J1xuICAgICAgICAgIC5zcGxpdCgnLCcpO1xuICBjb25zdCBFVkVOVF9UQVJHRVQgPSAnRXZlbnRUYXJnZXQnO1xuXG4gIGxldCBhcGlzID0gW107XG4gIGNvbnN0IGlzV3RmID0gX2dsb2JhbFsnd3RmJ107XG4gIGNvbnN0IFdURl9JU1NVRV81NTVfQVJSQVkgPSBXVEZfSVNTVUVfNTU1LnNwbGl0KCcsJyk7XG5cbiAgaWYgKGlzV3RmKSB7XG4gICAgLy8gV29ya2Fyb3VuZCBmb3I6IGh0dHBzOi8vZ2l0aHViLmNvbS9nb29nbGUvdHJhY2luZy1mcmFtZXdvcmsvaXNzdWVzLzU1NVxuICAgIGFwaXMgPSBXVEZfSVNTVUVfNTU1X0FSUkFZLm1hcCgodikgPT4gJ0hUTUwnICsgdiArICdFbGVtZW50JykuY29uY2F0KE5PX0VWRU5UX1RBUkdFVCk7XG4gIH0gZWxzZSBpZiAoX2dsb2JhbFtFVkVOVF9UQVJHRVRdKSB7XG4gICAgYXBpcy5wdXNoKEVWRU5UX1RBUkdFVCk7XG4gIH0gZWxzZSB7XG4gICAgLy8gTm90ZTogRXZlbnRUYXJnZXQgaXMgbm90IGF2YWlsYWJsZSBpbiBhbGwgYnJvd3NlcnMsXG4gICAgLy8gaWYgaXQncyBub3QgYXZhaWxhYmxlLCB3ZSBpbnN0ZWFkIHBhdGNoIHRoZSBBUElzIGluIHRoZSBJREwgdGhhdCBpbmhlcml0IGZyb20gRXZlbnRUYXJnZXRcbiAgICBhcGlzID0gTk9fRVZFTlRfVEFSR0VUO1xuICB9XG5cbiAgY29uc3QgaXNEaXNhYmxlSUVDaGVjayA9IF9nbG9iYWxbJ19fWm9uZV9kaXNhYmxlX0lFX2NoZWNrJ10gfHwgZmFsc2U7XG4gIGNvbnN0IGlzRW5hYmxlQ3Jvc3NDb250ZXh0Q2hlY2sgPSBfZ2xvYmFsWydfX1pvbmVfZW5hYmxlX2Nyb3NzX2NvbnRleHRfY2hlY2snXSB8fCBmYWxzZTtcbiAgY29uc3QgaWVPckVkZ2UgPSBpc0lFT3JFZGdlKCk7XG5cbiAgY29uc3QgQUREX0VWRU5UX0xJU1RFTkVSX1NPVVJDRSA9ICcuYWRkRXZlbnRMaXN0ZW5lcjonO1xuICBjb25zdCBGVU5DVElPTl9XUkFQUEVSID0gJ1tvYmplY3QgRnVuY3Rpb25XcmFwcGVyXSc7XG4gIGNvbnN0IEJST1dTRVJfVE9PTFMgPSAnZnVuY3Rpb24gX19CUk9XU0VSVE9PTFNfQ09OU09MRV9TQUZFRlVOQygpIHsgW25hdGl2ZSBjb2RlXSB9JztcblxuICAvLyAgcHJlZGVmaW5lIGFsbCBfX3pvbmVfc3ltYm9sX18gKyBldmVudE5hbWUgKyB0cnVlL2ZhbHNlIHN0cmluZ1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGV2ZW50TmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCBldmVudE5hbWUgPSBldmVudE5hbWVzW2ldO1xuICAgIGNvbnN0IGZhbHNlRXZlbnROYW1lID0gZXZlbnROYW1lICsgRkFMU0VfU1RSO1xuICAgIGNvbnN0IHRydWVFdmVudE5hbWUgPSBldmVudE5hbWUgKyBUUlVFX1NUUjtcbiAgICBjb25zdCBzeW1ib2wgPSBaT05FX1NZTUJPTF9QUkVGSVggKyBmYWxzZUV2ZW50TmFtZTtcbiAgICBjb25zdCBzeW1ib2xDYXB0dXJlID0gWk9ORV9TWU1CT0xfUFJFRklYICsgdHJ1ZUV2ZW50TmFtZTtcbiAgICB6b25lU3ltYm9sRXZlbnROYW1lc1tldmVudE5hbWVdID0ge307XG4gICAgem9uZVN5bWJvbEV2ZW50TmFtZXNbZXZlbnROYW1lXVtGQUxTRV9TVFJdID0gc3ltYm9sO1xuICAgIHpvbmVTeW1ib2xFdmVudE5hbWVzW2V2ZW50TmFtZV1bVFJVRV9TVFJdID0gc3ltYm9sQ2FwdHVyZTtcbiAgfVxuXG4gIC8vICBwcmVkZWZpbmUgYWxsIHRhc2suc291cmNlIHN0cmluZ1xuICBmb3IgKGxldCBpID0gMDsgaSA8IFdURl9JU1NVRV81NTUubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCB0YXJnZXQ6IGFueSA9IFdURl9JU1NVRV81NTVfQVJSQVlbaV07XG4gICAgY29uc3QgdGFyZ2V0czogYW55ID0gZ2xvYmFsU291cmNlc1t0YXJnZXRdID0ge307XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCBldmVudE5hbWVzLmxlbmd0aDsgaisrKSB7XG4gICAgICBjb25zdCBldmVudE5hbWUgPSBldmVudE5hbWVzW2pdO1xuICAgICAgdGFyZ2V0c1tldmVudE5hbWVdID0gdGFyZ2V0ICsgQUREX0VWRU5UX0xJU1RFTkVSX1NPVVJDRSArIGV2ZW50TmFtZTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBjaGVja0lFQW5kQ3Jvc3NDb250ZXh0ID0gZnVuY3Rpb24oXG4gICAgICBuYXRpdmVEZWxlZ2F0ZTogYW55LCBkZWxlZ2F0ZTogYW55LCB0YXJnZXQ6IGFueSwgYXJnczogYW55KSB7XG4gICAgaWYgKCFpc0Rpc2FibGVJRUNoZWNrICYmIGllT3JFZGdlKSB7XG4gICAgICBpZiAoaXNFbmFibGVDcm9zc0NvbnRleHRDaGVjaykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHRlc3RTdHJpbmcgPSBkZWxlZ2F0ZS50b1N0cmluZygpO1xuICAgICAgICAgIGlmICgodGVzdFN0cmluZyA9PT0gRlVOQ1RJT05fV1JBUFBFUiB8fCB0ZXN0U3RyaW5nID09IEJST1dTRVJfVE9PTFMpKSB7XG4gICAgICAgICAgICBuYXRpdmVEZWxlZ2F0ZS5hcHBseSh0YXJnZXQsIGFyZ3MpO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICBuYXRpdmVEZWxlZ2F0ZS5hcHBseSh0YXJnZXQsIGFyZ3MpO1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgdGVzdFN0cmluZyA9IGRlbGVnYXRlLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmICgodGVzdFN0cmluZyA9PT0gRlVOQ1RJT05fV1JBUFBFUiB8fCB0ZXN0U3RyaW5nID09IEJST1dTRVJfVE9PTFMpKSB7XG4gICAgICAgICAgbmF0aXZlRGVsZWdhdGUuYXBwbHkodGFyZ2V0LCBhcmdzKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGlzRW5hYmxlQ3Jvc3NDb250ZXh0Q2hlY2spIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGRlbGVnYXRlLnRvU3RyaW5nKCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBuYXRpdmVEZWxlZ2F0ZS5hcHBseSh0YXJnZXQsIGFyZ3MpO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIGNvbnN0IGFwaVR5cGVzOiBhbnlbXSA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IGFwaXMubGVuZ3RoOyBpKyspIHtcbiAgICBjb25zdCB0eXBlID0gX2dsb2JhbFthcGlzW2ldXTtcbiAgICBhcGlUeXBlcy5wdXNoKHR5cGUgJiYgdHlwZS5wcm90b3R5cGUpO1xuICB9XG4gIC8vIHZoIGlzIHZhbGlkYXRlSGFuZGxlciB0byBjaGVjayBldmVudCBoYW5kbGVyXG4gIC8vIGlzIHZhbGlkIG9yIG5vdChmb3Igc2VjdXJpdHkgY2hlY2spXG4gIHBhdGNoRXZlbnRUYXJnZXQoX2dsb2JhbCwgYXBpVHlwZXMsIHt2aDogY2hlY2tJRUFuZENyb3NzQ29udGV4dH0pO1xuICBhcGkucGF0Y2hFdmVudFRhcmdldCA9IHBhdGNoRXZlbnRUYXJnZXQ7XG5cbiAgcmV0dXJuIHRydWU7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXRjaEV2ZW50KGdsb2JhbDogYW55LCBhcGk6IF9ab25lUHJpdmF0ZSkge1xuICBwYXRjaEV2ZW50UHJvdG90eXBlKGdsb2JhbCwgYXBpKTtcbn1cbiJdfQ==