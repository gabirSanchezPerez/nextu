"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var Subject_1 = require("../Subject");
var async_1 = require("../scheduler/async");
var Subscriber_1 = require("../Subscriber");
var isNumeric_1 = require("../util/isNumeric");
var isScheduler_1 = require("../util/isScheduler");
function windowTime(windowTimeSpan) {
    var scheduler = async_1.async;
    var windowCreationInterval = null;
    var maxWindowSize = Number.POSITIVE_INFINITY;
    if (isScheduler_1.isScheduler(arguments[3])) {
        scheduler = arguments[3];
    }
    if (isScheduler_1.isScheduler(arguments[2])) {
        scheduler = arguments[2];
    }
    else if (isNumeric_1.isNumeric(arguments[2])) {
        maxWindowSize = arguments[2];
    }
    if (isScheduler_1.isScheduler(arguments[1])) {
        scheduler = arguments[1];
    }
    else if (isNumeric_1.isNumeric(arguments[1])) {
        windowCreationInterval = arguments[1];
    }
    return function windowTimeOperatorFunction(source) {
        return source.lift(new WindowTimeOperator(windowTimeSpan, windowCreationInterval, maxWindowSize, scheduler));
    };
}
exports.windowTime = windowTime;
var WindowTimeOperator = /** @class */ (function () {
    function WindowTimeOperator(windowTimeSpan, windowCreationInterval, maxWindowSize, scheduler) {
        this.windowTimeSpan = windowTimeSpan;
        this.windowCreationInterval = windowCreationInterval;
        this.maxWindowSize = maxWindowSize;
        this.scheduler = scheduler;
    }
    WindowTimeOperator.prototype.call = function (subscriber, source) {
        return source.subscribe(new WindowTimeSubscriber(subscriber, this.windowTimeSpan, this.windowCreationInterval, this.maxWindowSize, this.scheduler));
    };
    return WindowTimeOperator;
}());
var CountedSubject = /** @class */ (function (_super) {
    __extends(CountedSubject, _super);
    function CountedSubject() {
        var _this = _super !== null && _super.apply(this, arguments) || this;
        _this._numberOfNextedValues = 0;
        return _this;
    }
    CountedSubject.prototype.next = function (value) {
        this._numberOfNextedValues++;
        _super.prototype.next.call(this, value);
    };
    Object.defineProperty(CountedSubject.prototype, "numberOfNextedValues", {
        get: function () {
            return this._numberOfNextedValues;
        },
        enumerable: true,
        configurable: true
    });
    return CountedSubject;
}(Subject_1.Subject));
/**
 * We need this JSDoc comment for affecting ESDoc.
 * @ignore
 * @extends {Ignored}
 */
var WindowTimeSubscriber = /** @class */ (function (_super) {
    __extends(WindowTimeSubscriber, _super);
    function WindowTimeSubscriber(destination, windowTimeSpan, windowCreationInterval, maxWindowSize, scheduler) {
        var _this = _super.call(this, destination) || this;
        _this.destination = destination;
        _this.windowTimeSpan = windowTimeSpan;
        _this.windowCreationInterval = windowCreationInterval;
        _this.maxWindowSize = maxWindowSize;
        _this.scheduler = scheduler;
        _this.windows = [];
        var window = _this.openWindow();
        if (windowCreationInterval !== null && windowCreationInterval >= 0) {
            var closeState = { subscriber: _this, window: window, context: null };
            var creationState = { windowTimeSpan: windowTimeSpan, windowCreationInterval: windowCreationInterval, subscriber: _this, scheduler: scheduler };
            _this.add(scheduler.schedule(dispatchWindowClose, windowTimeSpan, closeState));
            _this.add(scheduler.schedule(dispatchWindowCreation, windowCreationInterval, creationState));
        }
        else {
            var timeSpanOnlyState = { subscriber: _this, window: window, windowTimeSpan: windowTimeSpan };
            _this.add(scheduler.schedule(dispatchWindowTimeSpanOnly, windowTimeSpan, timeSpanOnlyState));
        }
        return _this;
    }
    WindowTimeSubscriber.prototype._next = function (value) {
        var windows = this.windows;
        var len = windows.length;
        for (var i = 0; i < len; i++) {
            var window_1 = windows[i];
            if (!window_1.closed) {
                window_1.next(value);
                if (window_1.numberOfNextedValues >= this.maxWindowSize) {
                    this.closeWindow(window_1);
                }
            }
        }
    };
    WindowTimeSubscriber.prototype._error = function (err) {
        var windows = this.windows;
        while (windows.length > 0) {
            windows.shift().error(err);
        }
        this.destination.error(err);
    };
    WindowTimeSubscriber.prototype._complete = function () {
        var windows = this.windows;
        while (windows.length > 0) {
            var window_2 = windows.shift();
            if (!window_2.closed) {
                window_2.complete();
            }
        }
        this.destination.complete();
    };
    WindowTimeSubscriber.prototype.openWindow = function () {
        var window = new CountedSubject();
        this.windows.push(window);
        var destination = this.destination;
        destination.next(window);
        return window;
    };
    WindowTimeSubscriber.prototype.closeWindow = function (window) {
        window.complete();
        var windows = this.windows;
        windows.splice(windows.indexOf(window), 1);
    };
    return WindowTimeSubscriber;
}(Subscriber_1.Subscriber));
function dispatchWindowTimeSpanOnly(state) {
    var subscriber = state.subscriber, windowTimeSpan = state.windowTimeSpan, window = state.window;
    if (window) {
        subscriber.closeWindow(window);
    }
    state.window = subscriber.openWindow();
    this.schedule(state, windowTimeSpan);
}
function dispatchWindowCreation(state) {
    var windowTimeSpan = state.windowTimeSpan, subscriber = state.subscriber, scheduler = state.scheduler, windowCreationInterval = state.windowCreationInterval;
    var window = subscriber.openWindow();
    var action = this;
    var context = { action: action, subscription: null };
    var timeSpanState = { subscriber: subscriber, window: window, context: context };
    context.subscription = scheduler.schedule(dispatchWindowClose, windowTimeSpan, timeSpanState);
    action.add(context.subscription);
    action.schedule(state, windowCreationInterval);
}
function dispatchWindowClose(state) {
    var subscriber = state.subscriber, window = state.window, context = state.context;
    if (context && context.action && context.subscription) {
        context.action.remove(context.subscription);
    }
    subscriber.closeWindow(window);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2luZG93VGltZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIndpbmRvd1RpbWUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxzQ0FBcUM7QUFFckMsNENBQTJDO0FBQzNDLDRDQUEyQztBQUczQywrQ0FBOEM7QUFDOUMsbURBQWtEO0FBc0ZsRCxTQUFnQixVQUFVLENBQUksY0FBc0I7SUFDbEQsSUFBSSxTQUFTLEdBQWtCLGFBQUssQ0FBQztJQUNyQyxJQUFJLHNCQUFzQixHQUFXLElBQUksQ0FBQztJQUMxQyxJQUFJLGFBQWEsR0FBVyxNQUFNLENBQUMsaUJBQWlCLENBQUM7SUFFckQsSUFBSSx5QkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQzdCLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDMUI7SUFFRCxJQUFJLHlCQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDN0IsU0FBUyxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUMxQjtTQUFNLElBQUkscUJBQVMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRTtRQUNsQyxhQUFhLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzlCO0lBRUQsSUFBSSx5QkFBVyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO1FBQzdCLFNBQVMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDMUI7U0FBTSxJQUFJLHFCQUFTLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7UUFDbEMsc0JBQXNCLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ3ZDO0lBRUQsT0FBTyxTQUFTLDBCQUEwQixDQUFDLE1BQXFCO1FBQzlELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLGtCQUFrQixDQUFJLGNBQWMsRUFBRSxzQkFBc0IsRUFB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WSxFQUFPLElBQUksRUFBRSxDQUFDO0lBQ3pFLElBQU0sYUFBYSxHQUFrQixFQUFFLFVBQVUsWUFBQSxFQUFFLE1BQU0sUUFBQSxFQUFFLE9BQU8sU0FBQSxFQUFFLENBQUM7SUFDckUsT0FBTyxDQUFDLFlBQVksR0FBRyxTQUFTLENBQUMsUUFBUSxDQUFnQixtQkFBbUIsRUFBRSxjQUFjLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFDN0csTUFBTSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztBQUNqRCxDQUFDO0FBRUQsU0FBUyxtQkFBbUIsQ0FBSSxLQUFvQjtJQUMxQyxJQUFBLDZCQUFVLEVBQUUscUJBQU0sRUFBRSx1QkFBTyxDQUFXO0lBQzlDLElBQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksT0FBTyxDQUFDLFlBQVksRUFBRTtRQUNyRCxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7S0FDN0M7SUFDRCxVQUFVLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ2pDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAnLi4vU3ViamVjdCc7XG5pbXBvcnQgeyBPcGVyYXRvciB9IGZyb20gJy4uL09wZXJhdG9yJztcbmltcG9ydCB7IGFzeW5jIH0gZnJvbSAnLi4vc2NoZWR1bGVyL2FzeW5jJztcbmltcG9ydCB7IFN1YnNjcmliZXIgfSBmcm9tICcuLi9TdWJzY3JpYmVyJztcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICcuLi9PYnNlcnZhYmxlJztcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJy4uL1N1YnNjcmlwdGlvbic7XG5pbXBvcnQgeyBpc051bWVyaWMgfSBmcm9tICcuLi91dGlsL2lzTnVtZXJpYyc7XG5pbXBvcnQgeyBpc1NjaGVkdWxlciB9IGZyb20gJy4uL3V0aWwvaXNTY2hlZHVsZXInO1xuaW1wb3J0IHsgT3BlcmF0b3JGdW5jdGlvbiwgU2NoZWR1bGVyTGlrZSwgU2NoZWR1bGVyQWN0aW9uIH0gZnJvbSAnLi4vdHlwZXMnO1xuXG4vKipcbiAqIEJyYW5jaCBvdXQgdGhlIHNvdXJjZSBPYnNlcnZhYmxlIHZhbHVlcyBhcyBhIG5lc3RlZCBPYnNlcnZhYmxlIHBlcmlvZGljYWxseVxuICogaW4gdGltZS5cbiAqXG4gKiA8c3BhbiBjbGFzcz1cImluZm9ybWFsXCI+SXQncyBsaWtlIHtAbGluayBidWZmZXJUaW1lfSwgYnV0IGVtaXRzIGEgbmVzdGVkXG4gKiBPYnNlcnZhYmxlIGluc3RlYWQgb2YgYW4gYXJyYXkuPC9zcGFuPlxuICpcbiAqICFbXSh3aW5kb3dUaW1lLnBuZylcbiAqXG4gKiBSZXR1cm5zIGFuIE9ic2VydmFibGUgdGhhdCBlbWl0cyB3aW5kb3dzIG9mIGl0ZW1zIGl0IGNvbGxlY3RzIGZyb20gdGhlIHNvdXJjZVxuICogT2JzZXJ2YWJsZS4gVGhlIG91dHB1dCBPYnNlcnZhYmxlIHN0YXJ0cyBhIG5ldyB3aW5kb3cgcGVyaW9kaWNhbGx5LCBhc1xuICogZGV0ZXJtaW5lZCBieSB0aGUgYHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWxgIGFyZ3VtZW50LiBJdCBlbWl0cyBlYWNoIHdpbmRvd1xuICogYWZ0ZXIgYSBmaXhlZCB0aW1lc3Bhbiwgc3BlY2lmaWVkIGJ5IHRoZSBgd2luZG93VGltZVNwYW5gIGFyZ3VtZW50LiBXaGVuIHRoZVxuICogc291cmNlIE9ic2VydmFibGUgY29tcGxldGVzIG9yIGVuY291bnRlcnMgYW4gZXJyb3IsIHRoZSBvdXRwdXQgT2JzZXJ2YWJsZVxuICogZW1pdHMgdGhlIGN1cnJlbnQgd2luZG93IGFuZCBwcm9wYWdhdGVzIHRoZSBub3RpZmljYXRpb24gZnJvbSB0aGUgc291cmNlXG4gKiBPYnNlcnZhYmxlLiBJZiBgd2luZG93Q3JlYXRpb25JbnRlcnZhbGAgaXMgbm90IHByb3ZpZGVkLCB0aGUgb3V0cHV0XG4gKiBPYnNlcnZhYmxlIHN0YXJ0cyBhIG5ldyB3aW5kb3cgd2hlbiB0aGUgcHJldmlvdXMgd2luZG93IG9mIGR1cmF0aW9uXG4gKiBgd2luZG93VGltZVNwYW5gIGNvbXBsZXRlcy4gSWYgYG1heFdpbmRvd0NvdW50YCBpcyBwcm92aWRlZCwgZWFjaCB3aW5kb3dcbiAqIHdpbGwgZW1pdCBhdCBtb3N0IGZpeGVkIG51bWJlciBvZiB2YWx1ZXMuIFdpbmRvdyB3aWxsIGNvbXBsZXRlIGltbWVkaWF0ZWx5XG4gKiBhZnRlciBlbWl0dGluZyBsYXN0IHZhbHVlIGFuZCBuZXh0IG9uZSBzdGlsbCB3aWxsIG9wZW4gYXMgc3BlY2lmaWVkIGJ5XG4gKiBgd2luZG93VGltZVNwYW5gIGFuZCBgd2luZG93Q3JlYXRpb25JbnRlcnZhbGAgYXJndW1lbnRzLlxuICpcbiAqICMjIEV4YW1wbGVzXG4gKiBJbiBldmVyeSB3aW5kb3cgb2YgMSBzZWNvbmQgZWFjaCwgZW1pdCBhdCBtb3N0IDIgY2xpY2sgZXZlbnRzXG4gKiBgYGBqYXZhc2NyaXB0XG4gKiBjb25zdCBjbGlja3MgPSBmcm9tRXZlbnQoZG9jdW1lbnQsICdjbGljaycpO1xuICogY29uc3QgcmVzdWx0ID0gY2xpY2tzLnBpcGUoXG4gKiAgIHdpbmRvd1RpbWUoMTAwMCksXG4gKiAgIG1hcCh3aW4gPT4gd2luLnRha2UoMikpLCAgIC8vIGVhY2ggd2luZG93IGhhcyBhdCBtb3N0IDIgZW1pc3Npb25zXG4gKiAgIG1lcmdlQWxsKCksICAgICAgICAgICAgICAgIC8vIGZsYXR0ZW4gdGhlIE9ic2VydmFibGUtb2YtT2JzZXJ2YWJsZXNcbiAqICk7XG4gKiByZXN1bHQuc3Vic2NyaWJlKHggPT4gY29uc29sZS5sb2coeCkpO1xuICogYGBgXG4gKlxuICogRXZlcnkgNSBzZWNvbmRzIHN0YXJ0IGEgd2luZG93IDEgc2Vjb25kIGxvbmcsIGFuZCBlbWl0IGF0IG1vc3QgMiBjbGljayBldmVudHMgcGVyIHdpbmRvd1xuICogYGBgamF2YXNjcmlwdFxuICogY29uc3QgY2xpY2tzID0gZnJvbUV2ZW50KGRvY3VtZW50LCAnY2xpY2snKTtcbiAqIGNvbnN0IHJlc3VsdCA9IGNsaWNrcy5waXBlKFxuICogICB3aW5kb3dUaW1lKDEwMDAsIDUwMDApLFxuICogICBtYXAod2luID0+IHdpbi50YWtlKDIpKSwgICAvLyBlYWNoIHdpbmRvdyBoYXMgYXQgbW9zdCAyIGVtaXNzaW9uc1xuICogICBtZXJnZUFsbCgpLCAgICAgICAgICAgICAgICAvLyBmbGF0dGVuIHRoZSBPYnNlcnZhYmxlLW9mLU9ic2VydmFibGVzXG4gKiApO1xuICogcmVzdWx0LnN1YnNjcmliZSh4ID0+IGNvbnNvbGUubG9nKHgpKTtcbiAqIGBgYFxuICpcbiAqIFNhbWUgYXMgZXhhbXBsZSBhYm92ZSBidXQgd2l0aCBtYXhXaW5kb3dDb3VudCBpbnN0ZWFkIG9mIHRha2VcbiAqIGBgYGphdmFzY3JpcHRcbiAqIGNvbnN0IGNsaWNrcyA9IGZyb21FdmVudChkb2N1bWVudCwgJ2NsaWNrJyk7XG4gKiBjb25zdCByZXN1bHQgPSBjbGlja3MucGlwZShcbiAqICAgd2luZG93VGltZSgxMDAwLCA1MDAwLCAyKSwgLy8gZWFjaCB3aW5kb3cgaGFzIHN0aWxsIGF0IG1vc3QgMiBlbWlzc2lvbnNcbiAqICAgbWVyZ2VBbGwoKSwgICAgICAgICAgICAgICAgLy8gZmxhdHRlbiB0aGUgT2JzZXJ2YWJsZS1vZi1PYnNlcnZhYmxlc1xuICogKTtcbiAqIHJlc3VsdC5zdWJzY3JpYmUoeCA9PiBjb25zb2xlLmxvZyh4KSk7XG4gKiBgYGBcbiAqXG4gKiBAc2VlIHtAbGluayB3aW5kb3d9XG4gKiBAc2VlIHtAbGluayB3aW5kb3dDb3VudH1cbiAqIEBzZWUge0BsaW5rIHdpbmRvd1RvZ2dsZX1cbiAqIEBzZWUge0BsaW5rIHdpbmRvd1doZW59XG4gKiBAc2VlIHtAbGluayBidWZmZXJUaW1lfVxuICpcbiAqIEBwYXJhbSB7bnVtYmVyfSB3aW5kb3dUaW1lU3BhbiBUaGUgYW1vdW50IG9mIHRpbWUgdG8gZmlsbCBlYWNoIHdpbmRvdy5cbiAqIEBwYXJhbSB7bnVtYmVyfSBbd2luZG93Q3JlYXRpb25JbnRlcnZhbF0gVGhlIGludGVydmFsIGF0IHdoaWNoIHRvIHN0YXJ0IG5ld1xuICogd2luZG93cy5cbiAqIEBwYXJhbSB7bnVtYmVyfSBbbWF4V2luZG93U2l6ZT1OdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFldIE1heCBudW1iZXIgb2ZcbiAqIHZhbHVlcyBlYWNoIHdpbmRvdyBjYW4gZW1pdCBiZWZvcmUgY29tcGxldGlvbi5cbiAqIEBwYXJhbSB7U2NoZWR1bGVyTGlrZX0gW3NjaGVkdWxlcj1hc3luY10gVGhlIHNjaGVkdWxlciBvbiB3aGljaCB0byBzY2hlZHVsZSB0aGVcbiAqIGludGVydmFscyB0aGF0IGRldGVybWluZSB3aW5kb3cgYm91bmRhcmllcy5cbiAqIEByZXR1cm4ge09ic2VydmFibGU8T2JzZXJ2YWJsZTxUPj59IEFuIG9ic2VydmFibGUgb2Ygd2luZG93cywgd2hpY2ggaW4gdHVyblxuICogYXJlIE9ic2VydmFibGVzLlxuICogQG1ldGhvZCB3aW5kb3dUaW1lXG4gKiBAb3duZXIgT2JzZXJ2YWJsZVxuICovXG5leHBvcnQgZnVuY3Rpb24gd2luZG93VGltZTxUPih3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE9wZXJhdG9yRnVuY3Rpb248VCwgT2JzZXJ2YWJsZTxUPj47XG5leHBvcnQgZnVuY3Rpb24gd2luZG93VGltZTxUPih3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE9wZXJhdG9yRnVuY3Rpb248VCwgT2JzZXJ2YWJsZTxUPj47XG5leHBvcnQgZnVuY3Rpb24gd2luZG93VGltZTxUPih3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWF4V2luZG93U2l6ZTogbnVtYmVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NoZWR1bGVyPzogU2NoZWR1bGVyTGlrZSk6IE9wZXJhdG9yRnVuY3Rpb248VCwgT2JzZXJ2YWJsZTxUPj47XG5cbmV4cG9ydCBmdW5jdGlvbiB3aW5kb3dUaW1lPFQ+KHdpbmRvd1RpbWVTcGFuOiBudW1iZXIpOiBPcGVyYXRvckZ1bmN0aW9uPFQsIE9ic2VydmFibGU8VD4+IHtcbiAgbGV0IHNjaGVkdWxlcjogU2NoZWR1bGVyTGlrZSA9IGFzeW5jO1xuICBsZXQgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyID0gbnVsbDtcbiAgbGV0IG1heFdpbmRvd1NpemU6IG51bWJlciA9IE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcblxuICBpZiAoaXNTY2hlZHVsZXIoYXJndW1lbnRzWzNdKSkge1xuICAgIHNjaGVkdWxlciA9IGFyZ3VtZW50c1szXTtcbiAgfVxuXG4gIGlmIChpc1NjaGVkdWxlcihhcmd1bWVudHNbMl0pKSB7XG4gICAgc2NoZWR1bGVyID0gYXJndW1lbnRzWzJdO1xuICB9IGVsc2UgaWYgKGlzTnVtZXJpYyhhcmd1bWVudHNbMl0pKSB7XG4gICAgbWF4V2luZG93U2l6ZSA9IGFyZ3VtZW50c1syXTtcbiAgfVxuXG4gIGlmIChpc1NjaGVkdWxlcihhcmd1bWVudHNbMV0pKSB7XG4gICAgc2NoZWR1bGVyID0gYXJndW1lbnRzWzFdO1xuICB9IGVsc2UgaWYgKGlzTnVtZXJpYyhhcmd1bWVudHNbMV0pKSB7XG4gICAgd2luZG93Q3JlYXRpb25JbnRlcnZhbCA9IGFyZ3VtZW50c1sxXTtcbiAgfVxuXG4gIHJldHVybiBmdW5jdGlvbiB3aW5kb3dUaW1lT3BlcmF0b3JGdW5jdGlvbihzb3VyY2U6IE9ic2VydmFibGU8VD4pIHtcbiAgICByZXR1cm4gc291cmNlLmxpZnQobmV3IFdpbmRvd1RpbWVPcGVyYXRvcjxUPih3aW5kb3dUaW1lU3Bhbiwgd2luZG93Q3JlYXRpb25JbnRlcnZhbCwgbWF4V2luZG93U2l6ZSwgc2NoZWR1bGVyKSk7XG4gIH07XG59XG5cbmNsYXNzIFdpbmRvd1RpbWVPcGVyYXRvcjxUPiBpbXBsZW1lbnRzIE9wZXJhdG9yPFQsIE9ic2VydmFibGU8VD4+IHtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHdpbmRvd1RpbWVTcGFuOiBudW1iZXIsXG4gICAgICAgICAgICAgIHByaXZhdGUgd2luZG93Q3JlYXRpb25JbnRlcnZhbDogbnVtYmVyIHwgbnVsbCxcbiAgICAgICAgICAgICAgcHJpdmF0ZSBtYXhXaW5kb3dTaXplOiBudW1iZXIsXG4gICAgICAgICAgICAgIHByaXZhdGUgc2NoZWR1bGVyOiBTY2hlZHVsZXJMaWtlKSB7XG4gIH1cblxuICBjYWxsKHN1YnNjcmliZXI6IFN1YnNjcmliZXI8T2JzZXJ2YWJsZTxUPj4sIHNvdXJjZTogYW55KTogYW55IHtcbiAgICByZXR1cm4gc291cmNlLnN1YnNjcmliZShuZXcgV2luZG93VGltZVN1YnNjcmliZXIoXG4gICAgICBzdWJzY3JpYmVyLCB0aGlzLndpbmRvd1RpbWVTcGFuLCB0aGlzLndpbmRvd0NyZWF0aW9uSW50ZXJ2YWwsIHRoaXMubWF4V2luZG93U2l6ZSwgdGhpcy5zY2hlZHVsZXJcbiAgICApKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgQ3JlYXRpb25TdGF0ZTxUPiB7XG4gIHdpbmRvd1RpbWVTcGFuOiBudW1iZXI7XG4gIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWw6IG51bWJlcjtcbiAgc3Vic2NyaWJlcjogV2luZG93VGltZVN1YnNjcmliZXI8VD47XG4gIHNjaGVkdWxlcjogU2NoZWR1bGVyTGlrZTtcbn1cblxuaW50ZXJmYWNlIFRpbWVTcGFuT25seVN0YXRlPFQ+IHtcbiAgICB3aW5kb3c6IENvdW50ZWRTdWJqZWN0PFQ+O1xuICAgIHdpbmRvd1RpbWVTcGFuOiBudW1iZXI7XG4gICAgc3Vic2NyaWJlcjogV2luZG93VGltZVN1YnNjcmliZXI8VD47XG4gIH1cblxuaW50ZXJmYWNlIENsb3NlV2luZG93Q29udGV4dDxUPiB7XG4gIGFjdGlvbjogU2NoZWR1bGVyQWN0aW9uPENyZWF0aW9uU3RhdGU8VD4+O1xuICBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbn1cblxuaW50ZXJmYWNlIENsb3NlU3RhdGU8VD4ge1xuICBzdWJzY3JpYmVyOiBXaW5kb3dUaW1lU3Vic2NyaWJlcjxUPjtcbiAgd2luZG93OiBDb3VudGVkU3ViamVjdDxUPjtcbiAgY29udGV4dDogQ2xvc2VXaW5kb3dDb250ZXh0PFQ+O1xufVxuXG5jbGFzcyBDb3VudGVkU3ViamVjdDxUPiBleHRlbmRzIFN1YmplY3Q8VD4ge1xuICBwcml2YXRlIF9udW1iZXJPZk5leHRlZFZhbHVlczogbnVtYmVyID0gMDtcblxuICBuZXh0KHZhbHVlPzogVCk6IHZvaWQge1xuICAgIHRoaXMuX251bWJlck9mTmV4dGVkVmFsdWVzKys7XG4gICAgc3VwZXIubmV4dCh2YWx1ZSk7XG4gIH1cblxuICBnZXQgbnVtYmVyT2ZOZXh0ZWRWYWx1ZXMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5fbnVtYmVyT2ZOZXh0ZWRWYWx1ZXM7XG4gIH1cbn1cblxuLyoqXG4gKiBXZSBuZWVkIHRoaXMgSlNEb2MgY29tbWVudCBmb3IgYWZmZWN0aW5nIEVTRG9jLlxuICogQGlnbm9yZVxuICogQGV4dGVuZHMge0lnbm9yZWR9XG4gKi9cbmNsYXNzIFdpbmRvd1RpbWVTdWJzY3JpYmVyPFQ+IGV4dGVuZHMgU3Vic2NyaWJlcjxUPiB7XG4gIHByaXZhdGUgd2luZG93czogQ291bnRlZFN1YmplY3Q8VD5bXSA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBkZXN0aW5hdGlvbjogU3Vic2NyaWJlcjxPYnNlcnZhYmxlPFQ+PixcbiAgICAgICAgICAgICAgcHJpdmF0ZSB3aW5kb3dUaW1lU3BhbjogbnVtYmVyLFxuICAgICAgICAgICAgICBwcml2YXRlIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWw6IG51bWJlciB8IG51bGwsXG4gICAgICAgICAgICAgIHByaXZhdGUgbWF4V2luZG93U2l6ZTogbnVtYmVyLFxuICAgICAgICAgICAgICBwcml2YXRlIHNjaGVkdWxlcjogU2NoZWR1bGVyTGlrZSkge1xuICAgIHN1cGVyKGRlc3RpbmF0aW9uKTtcblxuICAgIGNvbnN0IHdpbmRvdyA9IHRoaXMub3BlbldpbmRvdygpO1xuICAgIGlmICh3aW5kb3dDcmVhdGlvbkludGVydmFsICE9PSBudWxsICYmIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWwgPj0gMCkge1xuICAgICAgY29uc3QgY2xvc2VTdGF0ZTogQ2xvc2VTdGF0ZTxUPiA9IHsgc3Vic2NyaWJlcjogdGhpcywgd2luZG93LCBjb250ZXh0OiA8YW55Pm51bGwgfTtcbiAgICAgIGNvbnN0IGNyZWF0aW9uU3RhdGU6IENyZWF0aW9uU3RhdGU8VD4gPSB7IHdpbmRvd1RpbWVTcGFuLCB3aW5kb3dDcmVhdGlvbkludGVydmFsLCBzdWJzY3JpYmVyOiB0aGlzLCBzY2hlZHVsZXIgfTtcbiAgICAgIHRoaXMuYWRkKHNjaGVkdWxlci5zY2hlZHVsZTxDbG9zZVN0YXRlPFQ+PihkaXNwYXRjaFdpbmRvd0Nsb3NlLCB3aW5kb3dUaW1lU3BhbiwgY2xvc2VTdGF0ZSkpO1xuICAgICAgdGhpcy5hZGQoc2NoZWR1bGVyLnNjaGVkdWxlPENyZWF0aW9uU3RhdGU8VD4+KGRpc3BhdGNoV2luZG93Q3JlYXRpb24sIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWwsIGNyZWF0aW9uU3RhdGUpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdGltZVNwYW5Pbmx5U3RhdGU6IFRpbWVTcGFuT25seVN0YXRlPFQ+ID0geyBzdWJzY3JpYmVyOiB0aGlzLCB3aW5kb3csIHdpbmRvd1RpbWVTcGFuIH07XG4gICAgICB0aGlzLmFkZChzY2hlZHVsZXIuc2NoZWR1bGU8VGltZVNwYW5Pbmx5U3RhdGU8VD4+KGRpc3BhdGNoV2luZG93VGltZVNwYW5Pbmx5LCB3aW5kb3dUaW1lU3BhbiwgdGltZVNwYW5Pbmx5U3RhdGUpKTtcbiAgICB9XG4gIH1cblxuICBwcm90ZWN0ZWQgX25leHQodmFsdWU6IFQpOiB2b2lkIHtcbiAgICBjb25zdCB3aW5kb3dzID0gdGhpcy53aW5kb3dzO1xuICAgIGNvbnN0IGxlbiA9IHdpbmRvd3MubGVuZ3RoO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspIHtcbiAgICAgIGNvbnN0IHdpbmRvdyA9IHdpbmRvd3NbaV07XG4gICAgICBpZiAoIXdpbmRvdy5jbG9zZWQpIHtcbiAgICAgICAgd2luZG93Lm5leHQodmFsdWUpO1xuICAgICAgICBpZiAod2luZG93Lm51bWJlck9mTmV4dGVkVmFsdWVzID49IHRoaXMubWF4V2luZG93U2l6ZSkge1xuICAgICAgICAgIHRoaXMuY2xvc2VXaW5kb3cod2luZG93KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb3RlY3RlZCBfZXJyb3IoZXJyOiBhbnkpOiB2b2lkIHtcbiAgICBjb25zdCB3aW5kb3dzID0gdGhpcy53aW5kb3dzO1xuICAgIHdoaWxlICh3aW5kb3dzLmxlbmd0aCA+IDApIHtcbiAgICAgIHdpbmRvd3Muc2hpZnQoKS5lcnJvcihlcnIpO1xuICAgIH1cbiAgICB0aGlzLmRlc3RpbmF0aW9uLmVycm9yKGVycik7XG4gIH1cblxuICBwcm90ZWN0ZWQgX2NvbXBsZXRlKCk6IHZvaWQge1xuICAgIGNvbnN0IHdpbmRvd3MgPSB0aGlzLndpbmRvd3M7XG4gICAgd2hpbGUgKHdpbmRvd3MubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3Qgd2luZG93ID0gd2luZG93cy5zaGlmdCgpO1xuICAgICAgaWYgKCF3aW5kb3cuY2xvc2VkKSB7XG4gICAgICAgIHdpbmRvdy5jb21wbGV0ZSgpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmRlc3RpbmF0aW9uLmNvbXBsZXRlKCk7XG4gIH1cblxuICBwdWJsaWMgb3BlbldpbmRvdygpOiBDb3VudGVkU3ViamVjdDxUPiB7XG4gICAgY29uc3Qgd2luZG93ID0gbmV3IENvdW50ZWRTdWJqZWN0PFQ+KCk7XG4gICAgdGhpcy53aW5kb3dzLnB1c2god2luZG93KTtcbiAgICBjb25zdCBkZXN0aW5hdGlvbiA9IHRoaXMuZGVzdGluYXRpb247XG4gICAgZGVzdGluYXRpb24ubmV4dCh3aW5kb3cpO1xuICAgIHJldHVybiB3aW5kb3c7XG4gIH1cblxuICBwdWJsaWMgY2xvc2VXaW5kb3cod2luZG93OiBDb3VudGVkU3ViamVjdDxUPik6IHZvaWQge1xuICAgIHdpbmRvdy5jb21wbGV0ZSgpO1xuICAgIGNvbnN0IHdpbmRvd3MgPSB0aGlzLndpbmRvd3M7XG4gICAgd2luZG93cy5zcGxpY2Uod2luZG93cy5pbmRleE9mKHdpbmRvdyksIDEpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGRpc3BhdGNoV2luZG93VGltZVNwYW5Pbmx5PFQ+KHRoaXM6IFNjaGVkdWxlckFjdGlvbjxUaW1lU3Bhbk9ubHlTdGF0ZTxUPj4sIHN0YXRlOiBUaW1lU3Bhbk9ubHlTdGF0ZTxUPik6IHZvaWQge1xuICBjb25zdCB7IHN1YnNjcmliZXIsIHdpbmRvd1RpbWVTcGFuLCB3aW5kb3cgfSA9IHN0YXRlO1xuICBpZiAod2luZG93KSB7XG4gICAgc3Vic2NyaWJlci5jbG9zZVdpbmRvdyh3aW5kb3cpO1xuICB9XG4gIHN0YXRlLndpbmRvdyA9IHN1YnNjcmliZXIub3BlbldpbmRvdygpO1xuICB0aGlzLnNjaGVkdWxlKHN0YXRlLCB3aW5kb3dUaW1lU3Bhbik7XG59XG5cbmZ1bmN0aW9uIGRpc3BhdGNoV2luZG93Q3JlYXRpb248VD4odGhpczogU2NoZWR1bGVyQWN0aW9uPENyZWF0aW9uU3RhdGU8VD4+LCBzdGF0ZTogQ3JlYXRpb25TdGF0ZTxUPik6IHZvaWQge1xuICBjb25zdCB7IHdpbmRvd1RpbWVTcGFuLCBzdWJzY3JpYmVyLCBzY2hlZHVsZXIsIHdpbmRvd0NyZWF0aW9uSW50ZXJ2YWwgfSA9IHN0YXRlO1xuICBjb25zdCB3aW5kb3cgPSBzdWJzY3JpYmVyLm9wZW5XaW5kb3coKTtcbiAgY29uc3QgYWN0aW9uID0gdGhpcztcbiAgbGV0IGNvbnRleHQ6IENsb3NlV2luZG93Q29udGV4dDxUPiA9IHsgYWN0aW9uLCBzdWJzY3JpcHRpb246IDxhbnk+bnVsbCB9O1xuICBjb25zdCB0aW1lU3BhblN0YXRlOiBDbG9zZVN0YXRlPFQ+ID0geyBzdWJzY3JpYmVyLCB3aW5kb3csIGNvbnRleHQgfTtcbiAgY29udGV4dC5zdWJzY3JpcHRpb24gPSBzY2hlZHVsZXIuc2NoZWR1bGU8Q2xvc2VTdGF0ZTxUPj4oZGlzcGF0Y2hXaW5kb3dDbG9zZSwgd2luZG93VGltZVNwYW4sIHRpbWVTcGFuU3RhdGUpO1xuICBhY3Rpb24uYWRkKGNvbnRleHQuc3Vic2NyaXB0aW9uKTtcbiAgYWN0aW9uLnNjaGVkdWxlKHN0YXRlLCB3aW5kb3dDcmVhdGlvbkludGVydmFsKTtcbn1cblxuZnVuY3Rpb24gZGlzcGF0Y2hXaW5kb3dDbG9zZTxUPihzdGF0ZTogQ2xvc2VTdGF0ZTxUPik6IHZvaWQge1xuICBjb25zdCB7IHN1YnNjcmliZXIsIHdpbmRvdywgY29udGV4dCB9ID0gc3RhdGU7XG4gIGlmIChjb250ZXh0ICYmIGNvbnRleHQuYWN0aW9uICYmIGNvbnRleHQuc3Vic2NyaXB0aW9uKSB7XG4gICAgY29udGV4dC5hY3Rpb24ucmVtb3ZlKGNvbnRleHQuc3Vic2NyaXB0aW9uKTtcbiAgfVxuICBzdWJzY3JpYmVyLmNsb3NlV2luZG93KHdpbmRvdyk7XG59XG4iXX0=